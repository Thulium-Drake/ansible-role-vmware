---
# This playbook takes care of installing the correct packages
#
- name: 'Gather API host facts'
  ansible.builtin.setup:
    gather_subset:
      - 'min'
  register: 'api_facts'
  delegate_to: "{{ hostvars[item.item]['vsphere_api_host'] }}"

- name: 'Install packages - Debian-like'
  ansible.builtin.apt:
    name:
      - 'git'
      - 'python-pip'
    state: 'present'
  when: api_facts['ansible_facts']['os_family'] == "Debian"
  delegate_to: "{{ hostvars[item.item]['vsphere_api_host'] }}"

- name: 'Ensure dependencies - Redhat 7 or lower'
  when:
    - api_facts['ansible_facts']['os_family'] == "RedHat"
    - api_facts['ansible_facts']['distribution_major_version'] < 8
  delegate_to: "{{ hostvars[item.item]['vsphere_api_host'] }}"
  block:
    - name: "Configure extra repo's - Redhat"
      community.general.rhsm_repository:
        name: "rhel-server-rhscl-{{ api_facts['ansible_facts']['distribution_major_version'] }}-rpms"
        state: 'present'

    - name: 'Install packages - RedHat'
      ansible.builtin.yum:
        name:
          - 'git'
          - 'python27-python-pip'
        state: 'present'

    - name: 'Place wrapper scripts for SCL'
      ansible.builtin.copy:
        dest: "/usr/local/bin/{{ file }}"
        src: "{{ file }}"
        owner: 'root'
        group: 'root'
        mode: '0755'
      loop:
        - 'ansible_vmware_pip'
        - 'ansible_vmware_python'
      loop_control:
        loop_var: 'file'

- name: 'Ensure repos - Redhat 8 or up'
  when:
    - api_facts['ansible_facts']['os_family'] == "RedHat"
    - api_facts['ansible_facts']['distribution_major_version'] >= 8
  block:
    - name: 'Ensure packages'
      ansible.builtin.package:
        name:
          - 'git'
          - 'python3-pip'
        state: 'present'

- name: 'Check Ansible cache directory'
  ansible.builtin.file:
    state: 'directory'
    path: '/var/cache/ansible/'
    owner: 'root'
    group: 'root'
    mode: '0755'
  delegate_to: "{{ hostvars[item.item]['vsphere_api_host'] }}"

- name: 'Clone vSphere Automation SDK repo'
  ansible.builtin.git:
    repo: "{{ vsphere_sdk_url }}"
    dest: '/var/cache/ansible/vsphere-sdk'
    clone: true
    version: "{{ vsphere_sdk_branch }}"
  delegate_to: "{{ hostvars[item.item]['vsphere_api_host'] }}"

- name: 'Setup vSphere Automation SDK - RedHat 7 or lower'
  when:
    - api_facts['ansible_facts']['os_family'] == "RedHat"
    - api_facts['ansible_facts']['distribution_major_version'] < 8
  delegate_to: "{{ hostvars[item.item]['vsphere_api_host'] }}"
  block:
    - name: 'Install vSphere Automation SDK via pip - RedHat'
      ansible.builtin.pip:
        requirements: '/var/cache/ansible/vsphere-sdk/requirements.txt'
        extra_args: '--extra-index-url "file://///var/cache/ansible/vsphere-sdk/lib"'
        state: 'forcereinstall'
        executable: '/usr/local/bin/ansible_vmware_pip'

    - name: 'Please reconfigure the API host in the Ansible Inventory'
      ansible.builtin.fail:
        msg: |
          'This host needs to be reconfigured in the Ansible Inventory to
          continue running. Please check the documentation!'

- name: 'Install vSphere Automation SDK via pip'
  ansible.builtin.pip:
    requirements: '/var/cache/ansible/vsphere-sdk/requirements.txt'
    extra_args: '--extra-index-url "file://///var/cache/ansible/vsphere-sdk/lib"'
    state: 'forcereinstall'
  delegate_to: "{{ hostvars[item.item]['vsphere_api_host'] }}"
