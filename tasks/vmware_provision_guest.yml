---
# Create/edit the VM
- name: 'Ensure Virtual Machine status'
  community.vmware.vmware_guest:
    hostname: "{{ hostvars[vm]['vsphere_host'] }}"
    username: "{{ hostvars[vm]['vsphere_username'] }}"
    password: "{{ hostvars[vm]['vsphere_password'] }}"
    validate_certs: "{{ vsphere_validate_certs }}"
    datacenter: "{{ hostvars[vm]['vsphere_datacenter'] }}"
    force: "{{ vmware_target_force }}"
    name: "{{ vm }}"
    folder: "{{ vmware_target_folder }}"
    state: "{{ vmware_target_state }}"
    esxi_hostname: "{{ vmware_target_esxi_hostname | default(omit) }}"
    cluster: "{{ vmware_target_esxi_cluster | default(omit) }}"
    template: "{{ vmware_target_template }}"
    disk: "{{ vmware_target_disks }}"
    hardware:
      memory_mb: "{{ vmware_target_ram['mb'] }}"
      memory_reservation: "{{ vmware_target_ram['reserved_mb'] }}"
      memory_reservation_lock: "{{ vmware_target_ram['reservation_lock'] }}"
      mem_limit: "{{ vmware_target_ram['limit_mb'] }}"
      mem_reservation: "{{ vmware_target_ram['reserved_mb'] }}"
      hotadd_memory: "{{ vmware_target_ram['hotadd'] }}"
      num_cpus: "{{ vmware_target_cpu['cpus'] }}"
      num_cpu_cores_per_socket: "{{ vmware_target_cpu['cores_per_socket'] }}"
      cpu_limit: "{{ vmware_target_cpu['limit_mhz'] }}"
      cpu_reservation: "{{ vmware_target_cpu['reserved_mhz'] }}"
      hotadd_cpu: "{{ vmware_target_cpu['hotadd'] }}"
      hotremove_cpu: "{{ vmware_target_cpu['hotremove'] }}"
      scsi: "{{ vmware_target_scsi }}"
      version: "{{ vmware_target_vm_version }}"
      boot_firmware: "{{ vmware_target_boot_firmware }}"
    cdrom: "{{ vmware_target_cdrom }}"
    networks: "{{ vmware_target_networks }}"
    customization: "{{ vmware_target_customization | default('{}') }}"
    wait_for_ip_address: 'no'
  delegate_to: "{{ hostvars[vm]['vsphere_api_host'] }}"
  register: 'deploy'
  loop: "{{ query('inventory_hostnames', '{{ ansible_play_hosts }}') }}"
  loop_control:
    loop_var: 'vm'
  # Workaround for https://github.com/ansible/ansible/issues/41736
  retries: 2
  delay: 3
  until: not deploy.failed

# We need to mark as template in a seperate tasks, for some reason
# it is not possible to clone directly to a template.
- name: 'Ensure VM marked as template'
  community.vmware.vmware_guest:
    hostname: "{{ hostvars[vm]['vsphere_host'] }}"
    username: "{{ hostvars[vm]['vsphere_username'] }}"
    password: "{{ hostvars[vm]['vsphere_password'] }}"
    validate_certs: "{{ vsphere_validate_certs }}"
    datacenter: "{{ hostvars[vm]['vsphere_datacenter'] }}"
    force: "{{ vmware_target_force }}"
    name: "{{ vm }}"
    state: "{{ vmware_target_state }}"
    is_template: "{{ vmware_target_is_template }}"
    esxi_hostname: "{{ vmware_target_esxi_hostname | default(omit) }}"
    cluster: "{{ vmware_target_esxi_cluster | default(omit) }}"
  delegate_to: "{{ hostvars[vm]['vsphere_api_host'] }}"
  when: vmware_target_is_template
  loop: "{{ query('inventory_hostnames', '{{ ansible_play_hosts }}') }}"
  loop_control:
    loop_var: 'vm'
